#errorCatcher Echo
#encoding UTF-8
#import datetime
#set global $page = "sensormon"
#include "header.html.tmpl"

#def signal_symbol($obs)
    #set $sig = getattr($current, $obs).raw
    #set $class_span = '%s_symbol' % $obs
    #set $class_icon = 'bi bi-reception-%.0f' % $sig
    <span class="$class_span"><i class="$class_icon"></i></span>
#end def

#def battery_level2_symbol($obs)
    #set $batt = getattr($current, $obs).raw
    #set $class_span = '%s_symbol' % $obs
    #if $batt == 0.0
    #set $class_icon = 'bi bi-battery-full'
    #else
    #set $class_icon = 'bi bi-battery'
    #end if
    <span class="$class_span"><i class="$class_icon"></i></span>
#end def

#def battery_level6_symbol($obs)
    #set $batt = getattr($current, $obs).raw
    #set $class_span = '%s_symbol' % $obs
    #if $batt <= 1.0
    #set $class_icon = 'bi bi-battery'
    #elif $batt == 2.0
    #set $class_icon = 'bi bi-battery'
    #elif $batt == 3.0
    #set $class_icon = 'bi bi-battery-half'
    #elif $batt == 4.0
    #set $class_icon = 'bi bi-battery-full'
    #elif $batt == 5.0
    #set $class_icon = 'bi bi-battery-full'
    #elif $batt == 6.0
    #set $class_icon = 'bi bi-battery-charging'
    #end if
    <span class="$class_span"><i class="$class_icon"></i></span>
#end def

#def battery_volt2_symbol($obs)
    #set $batt = getattr($current, $obs)
    #set $class_span = $obs
    <span class="$class_span">$batt</span>
#end def

#def battery_volt4_symbol($obs)
    #set $batt = getattr($current, $obs)
    #set $class_span = $obs
    <span class="$class_span">$batt</span>
#end def

#def battery_dummy_symbol($obs)
    #set $class_span = '%s_symbol' % $obs
    <span class="$class_span"></span>
#end def

            <script type="text/javascript">
                var finalRotation;
                var homepage_graphgroup = "dummy";
                
                var mqttMsg;
                var mqttclient = "weiherhammer_" + "$page" + "_" + Math.floor(Math.random() * 999999999);
                var moment_locale = "$system_locale_js";
                moment.locale(moment_locale);
                
                ajaxweewx().then(function(weewx_data) { // This call will make sure json/weewx_data.json is loaded before anything else
                    update_with_weewx_data(weewx_data, false); // Initial call to update (date, daily high, low, etc)
                    weiherhammer_debug(weewx_data); // Make weewx_data.json available in debugging console
        
                    jQuery(document).ready(function() {
                        // Update the Last Updated timestamp with moment.js,
                        updated = tzAdjustedMoment( $current.dateTime.raw ).format("$obs.label.time_last_updated");
                        updated_text = "$obs.label.header_last_updated " + updated;
                        jQuery(".updated").html( updated_text );

                        showChart("$page");

                        if ( getURLvar("offline") && ( getURLvar("offline") == "true" || getURLvar("offline") == "1" ) ) {
                            weiherhammer_debug("MQTT: offline url var detected. Skipping MQTT connect.");
                        } else {
                            connect(); // Begin mqtt after weewx initial load
                            // If the Restart button is clicked, reconnect to mqtt and update weewx and forecast data
                            jQuery(document).on('click', '.restart-interval', function() { 
                                ajaxweewx().then(function(weewx_data) { // This call will make sure json/weewx_data.json is loaded before anything else
                                    update_with_weewx_data(weewx_data, false); // Initial call to update (date, daily high, low, etc)
                                    weiherhammer_debug(weewx_data); // Make weewx_data.json available in debugging console
                                    connect(); // Restart mqtt after weewx data's re-loaded
                                }).catch(function(e){
                                    console.log(e);
                                });
                            });
                        }
                    });
                }).catch(function(e) {
                    console.log(e);
                });
            </script>
            <div class="site-inner">
                <main class="content">
                    <article class="weewx $page" itemscope itemtype="https://schema.org/CreativeWork">
                        <!-- Top bar with city and share -->
                        <div class="wx-stn-info-container">
                            <div class="wx-stn-name">
                                <h1>$obs.label.page_header_sensormon</h1>
                            </div>
                            <div class="wx-stn-info">
                                $obs.label.powered_by
                            </div>
                            <div class="clear"></div>
                            <!-- Updated time ago -->
                            <div class="updated-wrapper">
                                <div class="onlineMarkerOuter">
                                    <span class="loadingMarker" style="display:none"></span>
                                    <span class="onlineMarker" style="display:none"></span>
                                    <span class="offlineMarker" style="display:none"></span>
                                    <div class="updated"></div><!-- AJAX moment.js -->
                                </div>
                            </div>
                            <div class="clear"></div>
                            <div class="last-updated-alert" style="display:none;"></div><!-- AJAX moment.js -->
                        </div>

                        <div class="row sensors-monitor-row">
                            <div class="col-md-12 sensors-monitor-headline">$gettext('sensors outdoor')</div>
                        </div>

                        <div class="row sensors-monitor-row">
                            <div class="sensors-monitor-table-container">
                                <table class="table table-striped table-sm sensors-monitor-table">
                                    <thead class="thead-light sensors-monitor-table-head">
                                        <tr>
                                            <th scope="col" class="sensors-monitor-table-head-headline sensors-monitor-table-head-sensor">$gettext('sensor')</th>
                                            <th scope="col" class="sensors-monitor-table-head-headline sensors-monitor-table-head-sig">$gettext('signal')</th>
                                            <th scope="col" class="sensors-monitor-table-head-headline sensors-monitor-table-head-batt">$gettext('battery')</th>
                                        </tr>
                                    </thead>
                                    <tbody class="table-group-divider sensors-monitor-table-body sensors-monitor-data">
                                        <tr>
                                            <th scope="row" class="sensors-monitor-table-body-sensor">$gettext('sensor_wh65')</th>
                                            <td class="sensors-monitor-table-body-sig">$signal_symbol("wh65_sig")</span></td>
                                            <td class="sensors-monitor-table-body-batt">$battery_level2_symbol("wh65_batt")</span></td>
                                        </tr>
                                        <tr>
                                            <th scope="row" class="sensors-monitor-table-body-sensor">$gettext('sensor_wh57')</th>
                                            <td class="sensors-monitor-table-body-sig">$signal_symbol("wh57_sig")</span></td>
                                            <td class="sensors-monitor-table-body-batt">$battery_level6_symbol("wh57_batt")</span></td>
                                        </tr>
                                        <tr>
                                            <th scope="row" class="sensors-monitor-table-body-sensor">$gettext('sensor_wh51_ch1')</th>
                                            <td class="sensors-monitor-table-body-sig">$signal_symbol("wh51_ch1_sig")</span></td>
                                            <td class="sensors-monitor-table-body-batt">$battery_volt2_symbol("wh51_ch1_batt")</span></td>
                                        </tr>
                                        <tr>
                                            <th scope="row" class="sensors-monitor-table-body-sensor">$gettext('sensor_solar')</th>
                                            <td class="sensors-monitor-table-body-sig">$signal_symbol("solar_sig")</span></td>
                                            <td class="sensors-monitor-table-body-batt">$battery_volt4_symbol("solar_batt")</span></td>
                                        </tr>
                                        <tr>
                                            <th scope="row" class="sensors-monitor-table-body-sensor">$gettext('sensor_airrohr')</th>
                                            <td class="sensors-monitor-table-body-sig">$signal_symbol("airrohr_sig")</span></td>
                                            <td class="sensors-monitor-table-body-batt">$battery_dummy_symbol("airrohr_batt")</span></td>
                                        </tr>
                                        <tr>
                                            <th scope="row" class="sensors-monitor-table-body-sensor">$gettext('sensor_allsky')</th>
                                            <td class="sensors-monitor-table-body-sig">$signal_symbol("asky_sig")</span></td>
                                            <td class="sensors-monitor-table-body-batt">$battery_dummy_symbol("asky_batt")</span></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="row" sensors-monitor-row style="margin-top:15px;">
                            <div class="graph-outer">
                                <div class="col-sm-6 col-md-6" id="OutdoorSignalQuality"></div>
                                <div class="col-sm-6 col-md-6" id="OutdoorBatteryStatus"></div>
                            </div>
                        </div>

                        <div class="row sensors-monitor-row">
                            <div class="col-md-12 sensors-monitor-headline">$gettext('sensors indoor')</div>
                        </div>
                        <div class="row sensors-monitor-row">
                            <div class="sensors-monitor-table-container">
                                <table class="table table-striped table-sm sensors-monitor-table">
                                    <thead class="thead-light sensors-monitor-table-head">
                                        <tr>
                                            <th scope="col" class="sensors-monitor-table-head-headline sensors-monitor-table-head-sensor">$gettext('sensor')</th>
                                            <th scope="col" class="sensors-monitor-table-head-headline sensors-monitor-table-head-sig">$gettext('signal')</th>
                                            <th scope="col" class="sensors-monitor-table-head-headline sensors-monitor-table-head-batt">$gettext('battery')</th>
                                        </tr>
                                    </thead>
                                    <tbody class="table-group-divider sensors-monitor-table-body sensors-monitor-data">
                                        <tr>
                                            <th scope="row" class="sensors-monitor-table-body-sensor">$gettext('sensor_wh31_ch1')</th>
                                            <td class="sensors-monitor-table-body-sig">$signal_symbol("wh31_ch1_sig")</span></td>
                                            <td class="sensors-monitor-table-body-batt">$battery_level2_symbol("wh31_ch1_batt")</span></td>
                                        </tr>
                                        <tr>
                                            <th scope="row" class="sensors-monitor-table-body-sensor">$gettext('sensor_wh31_ch2')</th>
                                            <td class="sensors-monitor-table-body-sig">$signal_symbol("wh31_ch2_sig")</span></td>
                                            <td class="sensors-monitor-table-body-batt">$battery_level2_symbol("wh31_ch2_batt")</span></td>
                                        </tr>
                                        <tr>
                                            <th scope="row" class="sensors-monitor-table-body-sensor">$gettext('sensor_wh31_ch3')</th>
                                            <td class="sensors-monitor-table-body-sig">$signal_symbol("wh31_ch3_sig")</span></td>
                                            <td class="sensors-monitor-table-body-batt">$battery_level2_symbol("wh31_ch3_batt")</span></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="row" sensors-monitor-row style="margin-top:15px;">
                            <div class="graph-outer">
                                <div class="col-sm-6 col-md-6" id="IndoorSignalQuality"></div>
                                <div class="col-sm-6 col-md-6" id="IndoorBatteryStatus"></div>
                            </div>
                        </div>

                        <div class="clear"></div>
                    </article>
                </main>
            </div>
#include "footer.html.tmpl"
